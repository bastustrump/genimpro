<!DOCTYPE html>
<head><title>GENIMPRO</title></head>

<meta charset="utf-8">

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/d3.hexbin.v0.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

<link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

    <link href="http://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic"
      rel="stylesheet"
      type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Raleway:400,300,700" rel="stylesheet"
      type="text/css">




<style>

body {
    overflow:hidden;
    background-color: darkgray;
    font-family: Lato,Helvetica,Arial,sans-serif;
	font-weight: 200;
}

::-webkit-scrollbar { 
    display: none; 
}

.vis  {
  height: 100%;
  width: 100%;
}


.vis text {
  fill: white;
  text-anchor: middle;
}

.details text {
  color: white;
  fill: white;
  font-size: 20px;
  text-anchor: middle;
}

.detailsInnerCircle {
  fill: white;
  opacity: 0.5;
}

.details .detailsView {
  fill: white;
}

.link {
  fill: none;
  stroke: #ccc;
  stroke-width: 1.5px;
  opacity: 0.2;

}

#play {
  fill: currentColor;
}

#pause {
  fill: currentColor;
}

#playButton:hover {
	color: SandyBrown;
}

#playButton{
	color: white;
}

#pauseButton:hover {
	color: SandyBrown;
}
#pauseButton {
	color: white;
}


.alert {
   width:40%;    
   margin: 0 auto;
}

.genotypeBar {
  fill: steelblue;
}

.genotypeBar:hover {
  fill: brown;
}

.phenotypeBar {
  fill: DarkTurquoise;
}

.phenotypeBar:hover {
  fill: brown;
}


.geneLine {
	fill: none;
	stroke-width: 1.5px;
}

h2 { 
   position: absolute; 
   top: 50px; 
   left: 0; 
   width: 100%; 
   text-align: center;
   font-size: 16pt;
   color: white;
   font-weight: 100;
}

.label {

	font-weight: 100;

}

.parameterInfoClose {

opacity: 0.5;
font-weight: 100;
font-size: 9pt;
}


.parameterInfoClose:hover {
	opacity: 1;
}

</style>


<body>

<nav class="navbar navbar-default">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand disabled" href="#"><span class="glyphicon glyphicon-equalizer" aria-hidden="true"></span> GENIMPRO</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

        <li class="dropdown">
          <a href="#" id="sessionButton"  class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Session <span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu" id="sessionSelector">
          </ul>
        </li>

        <li class="dropdown disabled">
          <a href="#" id="recordingButton"  class="dropdown-toggle disabled" data-toggle="dropdown" role="button" aria-expanded="false">Aufnahme <span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu" id="recordingSelector"></ul>
        </li>


        <p class="navbar-text" id="navbarTitle"></p>

      </ul>
      <form class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search">
        </div>
        <button type="submit" class="btn btn-default disabled"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
      </form>
      <!--<ul class="nav navbar-nav navbar-right">
        <li><a href="#"></a></li>
        <li class="dropdown disabled">
          <a href="#" class="dropdown-toggle disabled" data-toggle="dropdown" role="button" aria-expanded="false">Dropdown <span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
            <li><a href="#">Action</a></li>
            <li><a href="#">Another action</a></li>
            <li><a href="#">Something else here</a></li>
            <li class="divider"></li>
            <li><a href="#">Separated link</a></li>
          </ul>
        </li>
      </ul>-->
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

<div id="notes"></div>

<div>
	<svg class="vis"></svg>
	<h2><span class="label label-default" id="parameterInfo"></span></h3></h2>
</div>

<svg width="0" height="0">
	<defs>
    <path id="play" fill="#ffffff" d="M6 4l20 12-20 12z" class="play"></path>
    <path id="pause" fill="#ffffff" d="M4 4h10v24h-10zM18 4h10v24h-10z" class="pause"></path>
  </defs>
</svg>

<script>

var lang = "de"

function localisedString(key) {
	switch(key) {
	    case "nodata":
	        switch (lang) {
	        	case "de":
	        		return "Keine Daten gefunden.";
	        	case "en":
	        		return "No data found.";	        	
	        }
	        break;

	    case "SelectSession":
	        switch (lang) {
	        	case "de":
	        		return "Bitte w√§hlen Sie eine Session und eine Aufnahme aus.";
	        	case "en":
	        		return "Please select a session and a recording.";	        	
	        }	        

	        break;
	    default:
	        return "";
	}
}



function note(note) {
	$("#notes").html('<div class="alert alert-info alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>' + note + '</div>');
}


var trackColors = [
	["#0B615E","#A05112"],
	["#0B3861","#A05112"],
	["#66055E","#769007"]
	];

var webserviceHost;

if  (window.location.protocol=="file:") {

	webserviceHost = "http://localhost:8080/";

} else {

	webserviceHost = "http://forschung.hfm-nuernberg.de/genimpro-webservice/";

}

var alphabet = ['A','B','C','D','E','F','G','H','I','J','K'];

var trackID=0;
var samplerate = 48000;

var links = [];

var visHeight=500;
var trackHeight=100;

var detailsViewSize = 300;

var sessions = [];
var session = [];
var recordings = [];
var recording = [];
var nTracks=0;

var sequences = [];
var sequencesByTrack = [];
var sequence = [];


var xScale = d3.scale.linear();

var similarityLinkScale = d3.scale.linear()
	.domain([0.7,1.0])
	.range([0.1,2.0]);

var fitnessScale = [];

var phenotypeMaxima = [];

var tracksDataScale = d3.scale.linear();

 var line = d3.svg.line()
 .interpolate("bundle");

fitnessScale[0] = d3.scale.linear();
fitnessScale[0].range[trackColors[0]];
fitnessScale[1] = d3.scale.linear();
fitnessScale[1].range[trackColors[1]];
fitnessScale[2] = d3.scale.linear();
fitnessScale[2].range[trackColors[2]];


var genotypeScaleY = d3.scale.linear();
var genotypeScaleX = d3.scale.ordinal();

var phenotypeScaleY = d3.scale.linear();
var phenotypeScaleX = d3.scale.ordinal();

var clickedSequence = null;
var parameterLock = false;


$(window).load(function(){

	note(localisedString("SelectSession"));

     $(function(){
         $("#sessionSelector").on("click", "li", function(event){
             var sessionID = jQuery(this).attr("sessionID");
             $("#sessionButton").html($(this).find('a').text() + ' <span class="caret"></span>');
             $("#recordingButton").html("Aufnahme " + ' <span class="caret"></span>');
             loadSession(parseInt(sessionID));
         })

         $("#recordingSelector").on("click", "li", function(event){
             var recordingID = jQuery(this).attr("recordingID");
             $("#recordingButton").html($(this).find('a').text() + ' <span class="caret"></span>');
             loadRecording(parseInt(recordingID));
         })

     })

});

function sequenceForID(id) {
   for (var i=0;i<sequences.length;i++) {
  		if (sequences[i].ID == id) {
  			return sequences[i];
  		}
   }
}

d3.json(webserviceHost + "sessions", function(error, data) {
	sessions = data;

	var sessionSelector = d3.select("#sessionSelector");
	var sessionLi = sessionSelector.selectAll("li")
		    .data(sessions)
		  	.enter().append("li")
		  	.attr("sessionID", function(d, i) { return sessions[i]["ID"] ; })
		    .attr("role", "presentation");

	sessionLi.append("a")
		.attr("role", "menuitem")
		.attr("tabindex", "-1")
		.attr("href", "#")
		.text(function(d, i) { return "Session: " + sessions[i]["key"] ; });


});

function resetVis() {

	nTracks = 0;

	sequences = [];
	//$(".vis").find("*").not("rect, g").remove();
	totalDuration = 0;

	$("#navbarTitle").text("");
}


function loadSession(id) {

	$('#recordingButton').addClass('disabled');
	$('#recordingButton').parent().addClass('disabled');

	resetVis();
	
	d3.json(webserviceHost + "sessions/" + id, function(error, data) {
		recordings = data;

		
		var recordingSelector = d3.select("#recordingSelector");
		var recordingLi = recordingSelector.selectAll("li").data(recordings);

		recordingLi.exit().remove();
		recordingLi.enter().append("li");


		recordingLi.attr("recordingID", function(d, i) { return recordings[i]["ID"] ; })
		    .attr("role", "presentation")

		recordingLi.selectAll("a").remove();

		recordingLi.append("a")
			.attr("role", "menuitem")
			.attr("tabindex", "-1")
			.attr("href", "#")
			.text(function(d, i) { return "Aufnahme: " + recordings[i]["ID"] ; });

		

	     $('#recordingButton').removeClass('disabled');
	     $('#recordingButton').parent().removeClass('disabled');

	});

}



function loadRecording(id) {

	$("#notes").html("");
	resetVis();

	d3.json(webserviceHost + "recordings/" + id, function(error, data) {
		recording = data[0];

		for (var i=0;i<recording.tracks.length;i++) {

			//$(".vis").html("");
			//$(".vis").append('<g transform="translate(0,' + i * trackHeight + ')" id="track' + i + '"></g>');
			loadTrack(recording.tracks[i].ID,i); 

			$("#navbarTitle").text($("#navbarTitle").text() + recording.tracks[i].playerName + " (" + recording.tracks[i].playerInstrument + ")");

			if (i<recording.tracks.length-1) {
				$("#navbarTitle").text($("#navbarTitle").text() + ", "); 
			}
		}

	 	tracks.attr("height", trackHeight*recording.tracks.length);  
		nTracks = recording.tracks.length;

  });

}

function getPhenotypeMaxima() {

	var phenotypeKeys = [];
	var phenotypeValues = [];

	for(key in sequences[0]["phenotype"]) {
		phenotypeKeys.push(key);
		phenotypeValues[key] = [];
	} 

	for (var i=0;i<sequences.length;i++) { 

		for (var k=0;k<phenotypeKeys.length;k++) {
			phenotypeValues[phenotypeKeys[k]].push(sequences[i]["phenotype"][phenotypeKeys[k]]);
		}
	}

	for(key in phenotypeValues) {
		phenotypeMaxima[key] = (d3.max(phenotypeValues[key]));
	} 	
	console.log(phenotypeMaxima);

}

function flattenPhenotypeData(phenotypeData) {

	var flattenedPhenotypeData = {};

	for(key in phenotypeData) { 
		object = phenotypeData[key];

		for (innerKey in object) {
			flattenedPhenotypeData[key + " " + innerKey] = object[innerKey];
		}

	}
	return flattenedPhenotypeData;

}

function loadTrack(id,trackNumber) {

	d3.json(webserviceHost + "sequences/" + id, function(error, data) {

		sequenceParameters = ["phenotype","genotype"];

		sequencesByTrack[trackNumber] = [];

	    for	(index = 0; index < data.length; index++) {
	    	var sequence = [];
	    	sequence["track"] = trackNumber;
	    	sequence["start"] = data[index]["start"]/samplerate;
	    	sequence["duration"] = (data[index]["end"] - data[index]["start"])/samplerate;
	    	sequence["end"] = data[index]["end"]/samplerate;
	    	sequence["events"] = JSON.parse(data[index]["events"]);
	    	sequence["ID"] = data[index]["ID"];

	    	var relations = JSON.parse(data[index]["relations"]);
			sequence["fitness"] = relations["fitness"];
			sequence["children"] = relations["children"];
			sequence["parents"] = relations["parents"];

	    	for (p=0; p < sequenceParameters.length; p++) {
	    		var parameter = sequenceParameters[p];
	    		sequence[parameter] = []; 
				var value = data[index][parameter];

	    		if (value != null) {

	    				value = value.replace(/\bNaN\b/g, "null");
	    				value = value.replace("[]", "null");
	    				sequence[sequenceParameters[p]] = JSON.parse(value);

	    		}
	    	}
	    	sequence["phenotype"] = flattenPhenotypeData(sequence["phenotype"]);
	    	sequencesByTrack[trackNumber].push(sequence);
	    	sequences.push(sequence);
		}

		updateTracks();

	});


}

function updateTracks() {

	trackHeight = visHeight / nTracks;

	if (sequences.length==0) {
		note(localisedString("nodata"));
		$(".vis").find("*").not("rect, g").remove();
		return;
	}

	var fitnessMax = 0;

	for (var i=0;i<sequences.length;i++) {
		var trackPosition = 1-(sequences[i]["track"]  * (1 / nTracks) + (1 / (nTracks *2)));
		sequences[i]["initialY"] = tracksDataScale(trackPosition) - xScale(sequences[i]["duration"]/2);
		sequences[i]["y"] = sequences[i]["initialY"];

		sequences[i]["initialX"] = (xScale(1 + sequences[i]["start"] + (sequences[i]["duration"]/2)) - xScale(sequences[i]["duration"]/2));
		sequences[i]["x"] = sequences[i]["initialX"];

		if (sequences[i]["end"] > totalDuration) {
			totalDuration = sequences[i]["end"];
		}

		if (sequences[i]["fitness"] > fitnessMax) {
			fitnessMax = sequences[i]["fitness"];
		}		
	}

	getPhenotypeMaxima();

	durations = [];

	xScale.domain([0,totalDuration+10])
		.range([0,parseInt(vis.style("width"))]);

	fitnessScale[0].domain([0,fitnessMax])
	.range(trackColors[0]);
	fitnessScale[1].domain([0,fitnessMax])
	.range(trackColors[1]);
	fitnessScale[2].domain([0,fitnessMax])
	.range(trackColors[1]);


	vis.on("click", clickVis);

	var sequenceView = tracks.selectAll("g").data(sequences);

	sequenceView.enter().append("g")
	    .on("click", clickSequence)
		.on("mouseover", mouseover)
		;


	sequenceView.attr("transform", function(d, i) { return "translate(" + sequences[i]["x"] + "," + sequences[i]["y"] + ")"; })
		.attr("sequenceID",function(d, i) { return sequences[i]["ID"]; } );
	
	sequenceView.selectAll("circle").remove();

	sequenceView.append("circle")
		.attr("cy", function(d, i) { return xScale(sequences[i]["duration"]/2); })
	    .attr("cx", function(d, i) { 
	    	return xScale(sequences[i]["duration"]/2) ; })
	    .attr("r", function(d, i) { return xScale(sequences[i]["duration"]/2) ; })
	    .attr("fill", function(d, i) { return fitnessScale[sequences[i]["track"]](sequences[i]["fitness"]) ; })

	sequenceView.append("circle")
		.attr("cy", function(d, i) { return xScale(sequences[i]["duration"]/2); })
	    .attr("cx", function(d, i) { 
	    	return xScale(sequences[i]["duration"]/2) ; })
	    .attr("r", function(d, i) { 
	    	var radius = xScale(sequences[i]["duration"]/2);

	    	if (radius > 2.0) {
	    		return radius -2;
	    	} else {
	    	return  0.5 ; }
	    	})
	    //.attr("class",function(d, i) { return "track" + sequences[i]["track"] ; })
	    .attr("fill", function(d, i) { return trackColors[sequences[i]["track"]][0] ; })
	    //.attr("sequenceID",function(d, i) { return sequences[i]["ID"]; } );

	
            
	sequenceView.exit().remove();

	
	//tracksDataScale.range([(nTracks * trackHeight),0]);
	resize();
	clickVis();
}



function clickSequence(d) {

	d3.event.stopPropagation();

	details.transition().duration(50)
    	.style("opacity", 1);

    clickedSequence = sequenceForID(parseInt(d3.select(this).attr("sequenceID")));
    sequenceMouseleave();

	d3.select(".detailsView")
		.transition().duration(200)
		.style("fill",trackColors[clickedSequence["track"]][0]);

	//console.log(webserviceHost + "sequenceAudio/" + d3.select(this).attr("sequenceID"));

	$.get( webserviceHost + "sequenceAudio/" + d3.select(this).attr("sequenceID"), function( data ) {
		  var object = $($.parseHTML(data));
		  var element = object.filter('source');
		  $( "#audioElement" ).html( element );
		  $( "#audioElement" ).load();
		  console.log(element);
		})

	genotypeScaleY.range([0,180]).domain([0,1]);
	genotypeScaleX.rangeRoundBands([70, detailsViewSize-70],.1);

	phenotypeScaleY.range([0,180]).domain([0,100]);
	phenotypeScaleX.rangeRoundBands([70, detailsViewSize-70],.1);	

	drawPhenotypeChart(clickedSequence["phenotype"]);
	drawGenotypeChart(clickedSequence["genotype"]);
}

function drawPhenotypeChart(phenotypeData) {

	var phenotypeKeys = Object.keys(phenotypeData);
  	phenotypeScaleX.domain(d3.range(phenotypeKeys.length));

    var phenotypeChartView = phenotypeChart.selectAll(".phenotypeBar")
      .data(phenotypeKeys);

    phenotypeChartView.enter().append("rect")
    	.on("click",chartareaClick)
    	.on("mouseover",phenotypeBarMouseover);

    phenotypeChartView.attr("class", "phenotypeBar")
      .transition().duration(100)
      .attr("x", function(d,i) { return phenotypeScaleX(i); })
      .attr("width", phenotypeScaleX.rangeBand())
      .attr("y", function(d,i) { 
      	return detailsViewSize/2 - 26 - phenotypeScaleY(phenotypeData[phenotypeKeys[i]]); })
      .attr("height", function(d,i) { 
      	return phenotypeScaleY(phenotypeData[phenotypeKeys[i]]); })
      .attr("phenID", function(d,i) { return i; });

    phenotypeChartView.exit().remove();

}

function drawGenotypeChart(genotypeData) {

  	genotypeScaleX.domain(d3.range(genotypeData.length));

    var genotypeChartView = genotypeChart.selectAll(".genotypeBar")
      .data(genotypeData);

    genotypeChartView.enter().append("rect")
    	.on("click",chartareaClick)
    	.on("mouseover",genotypeBarMouseover);

    genotypeChartView.attr("class", "genotypeBar")
      .transition().duration(100)
      .attr("x", function(d,i) { return genotypeScaleX(i); })
      .attr("width", genotypeScaleX.rangeBand())
      .attr("y", detailsViewSize/2 + 26)
      .attr("height", function(d,i) { return genotypeScaleY(d); })
      .attr("geneID", function(d,i) { return i; });

    genotypeChartView.exit().remove();


}

function parameterLabel(label) {

	d3.select("#parameterInfo").html(label + "&nbsp;&nbsp;")
	.append("span").attr("class","glyphicon glyphicon-remove parameterInfoClose")
	.on("click",removeParameterLock);
//<span class= aria-hidden="true"></span>
}

function removeParameterLock() {

	d3.select("#parameterInfo").html("");
	parameterLock = false;

	sequenceMouseleave();
	chartareaMouseleave();

}

function phenotypeBarMouseover(d) {
	var phenID = parseInt(d3.select(this).attr("phenID"));
	var phenValues= [];

	var phenotypeKeys = Object.keys(clickedSequence["phenotype"]);

	sequences.forEach(function(c, j) {
		phenValues.push(c["phenotype"][phenotypeKeys[phenID]]);
	});

	tracksDataScale.domain([0,d3.max(phenValues)]);

	var sequenceView = tracks.selectAll("g")
	sequenceView
		.transition().duration(250).ease('circle')
		.attr("transform", function(d, i) { 
			sequences[i]["x"] = (xScale(1 + sequences[i]["start"] + (sequences[i]["duration"]/2)) - xScale(sequences[i]["duration"]));
			sequences[i]["y"] = (tracksDataScale(sequences[i]["phenotype"][phenotypeKeys[phenID]]) - xScale(sequences[i]["duration"]/2));
			return "translate(" + sequences[i]["x"] + "," + sequences[i]["y"] + ")"; });


	parameterLabel(phenotypeKeys[phenID]);

	var geneLine = d3.svg.line()
		.x(function(d,i) { return (xScale(1 + d["start"] + (d["duration"]/2)) - xScale(d["duration"]/2)) })
		.y(function(d,i) { return tracksDataScale(d["phenotype"][phenotypeKeys[phenID]]) });


	if (graphView.selectAll(".geneLine").empty()) {
		
			
	}

	graphView.selectAll(".geneLine")
	.transition().duration(50)
	.remove();

	for	(index = 0; index < nTracks; index++) {
		graphView.append("path")
			.attr("class","geneLine")
			.attr("stroke",trackColors[index][0])	
			.datum(sequencesByTrack[index])
			.transition().duration(500)
			.attr("d",geneLine)
			;
	}

	updateLinks(clickedSequence);


}


function genotypeBarMouseover(d) {
	var geneID = parseInt(d3.select(this).attr("geneID"));
	var geneValues= [];

	sequences.forEach(function(c, j) {
		geneValues.push(c["genotype"][geneID]);
	});

	tracksDataScale.domain([0,d3.max(geneValues)]);

	var sequenceView = tracks.selectAll("g")
	sequenceView
		.transition().duration(250).ease('circle')
		.attr("transform", function(d, i) { 
			sequences[i]["x"] = (xScale(1 + sequences[i]["start"] + (sequences[i]["duration"]/2)) - xScale(sequences[i]["duration"]));
			sequences[i]["y"] = (tracksDataScale(sequences[i]["genotype"][geneID]) - xScale(sequences[i]["duration"]/2));
			return "translate(" + sequences[i]["x"] + "," + sequences[i]["y"] + ")"; });


	parameterLabel("Gen " + alphabet[geneID]);

	var geneLine = d3.svg.line()
		.x(function(d,i) { return (xScale(1 + d["start"] + (d["duration"]/2)) - xScale(d["duration"]/2)) })
		.y(function(d,i) { return tracksDataScale(d["genotype"][geneID]) });




	if (graphView.selectAll(".geneLine").empty()) {
		
			
	}

	graphView.selectAll(".geneLine")
	.transition().duration(50)
	.remove();

	for	(index = 0; index < nTracks; index++) {
		graphView.append("path")
			.attr("class","geneLine")
			.attr("stroke",trackColors[index][0])	
			.datum(sequencesByTrack[index])
			.transition().duration(500)
			.attr("d",geneLine)
			;
	}

	updateLinks(clickedSequence);


}

function chartareaClick(d) {
	d3.event.stopPropagation();
	parameterLock = true;

}

function chartareaMouseleave(d) {

	if (parameterLock==true) {
		return;
	}

	$("parameterInfo").html("");

	var sequenceView = tracks.selectAll("g")

	graphView.selectAll(".geneLine")
		.transition().duration(10)
		.remove();

	sequenceView
		.transition().duration(200).ease('elastic')
		.attr("transform", function(d, i) { 
			sequences[i]["y"] = sequences[i]["initialY"];
			sequences[i]["x"] = sequences[i]["initialX"];
			return "translate(" + sequences[i]["x"] + "," + sequences[i]["y"] + ")"; });

	updateLinks(clickedSequence);
}




function clickVis(d) {

	clickedSequence = null;
	sequenceMouseleave();
	
	details.transition().duration(500)
    	.style("opacity", 0.0);	

    $( ".playerSpace" ).html( "" );

}

function sequenceMouseleave(d) {

  if (clickedSequence == null) {

  		tracks.selectAll("g")
	  	.transition().duration(600)
	    .style("opacity", 1);

	    links=[];

	    linkView.selectAll("path")
	      .transition().duration(200)
	      .style("opacity",0);

  } else {

   var children = [];   

   $.each(clickedSequence["children"], function( index, value ) {
  		children.push(value[0]);
	});

	tracks.selectAll("g")
		.transition().duration(300)
  	  	.style("opacity", function(d, i) {
  	  		if (sequences[i]["ID"] == clickedSequence["ID"]) {
	      		return 1.0;
	      	} 

	      	if ($.inArray(sequences[i]["ID"], children) != -1) {
	      		return 0.6;
	      	} else {
	      		return 0.1;
	      	}

      });


  }


}

function updateLinks(sequence) {

   links=[];
   sequence.children.forEach(function(c, j) {


	    	var s = [],t=[], m = [], dp1 = [], dp2=[];
	        //s.x = xScale(1 + thisSequence.start + thisSequence.duration/2);
	        //s.y = (thisSequence.track * trackHeight) + trackHeight/2;

	        s.x = thisSequence.x + xScale(thisSequence.duration/2) ;
	        s.y = thisSequence.y + xScale(thisSequence.duration/2) ;
	  		
	        var child = sequenceForID(c[0]);


	  		//t.x = xScale(1 + child.start + child.duration/2);
	  		//t.y = (child.track * trackHeight) + trackHeight/2;

	  		t.x = child.x + xScale(child.duration/2) ;
	  		t.y = child.y + xScale(child.duration/2) ;

	  		m.x = s.x + (t.x-s.x)/2;
	  		m.y = trackHeight;

	  		dp1.x=s.x;
	  		dp1.y=(s.y+m.y)/2;

	  		dp2.x=t.x;
	  		dp2.y=(t.y+m.y)/2;

       		links.push([[[s.x,s.y],[dp1.x,dp1.y],[m.x,m.y],[dp2.x,dp2.y],[t.x,t.y]],c[1]]);
        });


    var path = linkView.selectAll(".link")
    	.data(links);

    path.enter().append("path")
		.transition().delay(400).duration(100);

    path.attr("class","link")
    	.transition().duration(100)
      	.attr("d", function(d,i) { return line(d[0]); })
      	.style("stroke-width", function(d,i) { return similarityLinkScale(d[1]); })
		.style("opacity",1.0);

	path.exit()
		.transition().duration(100)
		.remove();

}

function mouseover(d) {

	if (clickedSequence != null) {
		return;
	}
	
	thisSequence = sequenceForID(parseInt(d3.select(this).attr("sequenceID")));

	updateLinks(thisSequence);

   var children = [];   

   $.each(thisSequence["children"], function( index, value ) {
  		children.push(value[0]);
	});

  tracks.selectAll("g")
  	.style("opacity", function(d, i) {
      	if ($.inArray(sequences[i]["ID"], children) != -1) {
      		return 1.0;
      	} else {
      		return 0.2;
      	}

      });

  d3.select(this)
  	.style("opacity",1.0);


}


function detailsViewClick() {
	d3.event.stopPropagation();

}


function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
  var angleInRadians = (angleInDegrees-90) * Math.PI / 180.0;

  return {
    x: centerX + (radius * Math.cos(angleInRadians)),
    y: centerY + (radius * Math.sin(angleInRadians))
  };
}

function describeArc(x, y, radius, startAngle,endAngle){

    var start = polarToCartesian(x, y, radius, endAngle);
    var end = polarToCartesian(x, y, radius, startAngle);

    var arcSweep = endAngle - startAngle <= 180 ? "0" : "1";

    var d = [
        "M", start.x, start.y, 
        "A", radius, radius, 0, arcSweep, 0, end.x, end.y,
        "L", start.x, start.y
    ].join(" ");

    return d;       
}


var vis = d3.select(".vis")
    .attr("height", "100%");

var graphView = vis.append("g")
	.attr("class","graph");

var linkView = vis.append("g")
	.attr("class","links");

var tracks = vis.append("g")
	.attr("class","tracks");
	//.attr("transform","translate(0,0)");



var detailsRadius = detailsViewSize/2;
var dInnerRadius = 10;

var details = vis.append("g")
	.attr("class","details")
	.style("visibility", "visible")
	.style("opacity", 0.0)
	.on("click",detailsViewClick);

var detailsView = details.append("g");

detailsView.append("circle")
		.attr("class","detailsView")
		.attr("cy", function(d, i) { return detailsViewSize/2; })
	    .attr("cx", function(d, i) { return detailsViewSize/2; })
	    .attr("r", function(d, i) { return detailsViewSize/2; });

    detailsView.append("path")
    .attr("class", "detailsInnerCircle")
    .attr("d", describeArc(detailsViewSize/2, detailsViewSize/2, detailsRadius - dInnerRadius, 360-80,80))
    .on("mouseleave",chartareaMouseleave);


     detailsView.append("path")
    .attr("class", "detailsInnerCircle")
    .attr("d", describeArc(detailsViewSize/2, detailsViewSize/2, detailsRadius - dInnerRadius, 100,360-100))
    .on("mouseleave",chartareaMouseleave);


function clickPlay(d) {

    document.getElementById("audioElement").play();
}

function playerHover(d) {

	console.log(d3.selectAll(".play"));
	d3.selectAll("#play").attr("fill","steelblue");

}

function clickPause(d) {
    document.getElementById("audioElement").pause();
}

  var playerControls = detailsView.append("g")
 	.attr("transform","translate(" + (detailsViewSize/2 - 25) + "," + (detailsViewSize/2 - 15) + ")");

   playerControls.append("use")
    	.attr("xlink:href","#play")
    	.attr("transform","scale(0.8)")
    	.attr("id","playButton")
    	.attr("x",0)
    	.attr("y",3)
    	.attr("height",32)
    	//.on("mouseover",playerHover)
    	.on("click",clickPlay);

   playerControls.append("use")
    	.attr("xlink:href","#pause")
    	.attr("id","pauseButton")
    	.attr("transform","scale(0.8)")
    	.attr("x",35)
    	.attr("y",3)
    	.attr("height",32)
    	//.on("mouseover",playerHover)
    	.on("click",clickPause);

    var phenotypeChart = detailsView.append("g").attr("class","phenotypeChart");
    var genotypeChart = detailsView.append("g").attr("class","genotypeChart");

  resize();
  d3.select(window).on("resize", resize);

  function resize() {
    width = window.innerWidth, height = window.innerHeight;
    var position = $(".vis").offset(); 

    visHeight = height - position.top ;
    vis.attr("width", width).attr("height", visHeight);

	tracksDataScale.range([visHeight - 50 ,50]);

	details.attr("transform", function(d, i) { return "translate(" + (parseInt(vis.style("width"))/2 - detailsViewSize/2) + "," +  (visHeight/2 - detailsViewSize/2) + ")";} );
	//detailsView.attr("transform","translate(" + (parseInt(vis.style("width"))/2 - detailsViewSize/2) + "," + nTracks * trackHeight + ")");

    //force.size([width, height]).resume();
  }

</script>

<audio id="audioElement"></audio>

</body>